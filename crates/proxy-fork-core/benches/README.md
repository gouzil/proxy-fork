# ProxyManager åŸºå‡†æµ‹è¯•

æœ¬ç›®å½•åŒ…å« ProxyManager çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œä½¿ç”¨ [codspeed](https://codspeed.io/) è¿›è¡Œæ€§èƒ½è¿½è¸ªã€‚

## è¿è¡ŒåŸºå‡†æµ‹è¯•

### æœ¬åœ°è¿è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
cargo bench --package proxy-fork-core --bench proxy_manager_bench

# è¿è¡Œç‰¹å®šæµ‹è¯•ç»„
cargo bench --package proxy-fork-core --bench proxy_manager_bench -- exact_match
cargo bench --package proxy-fork-core --bench proxy_manager_bench -- pattern_match
cargo bench --package proxy-fork-core --bench proxy_manager_bench -- cache_hit
```

### ä½¿ç”¨ CodSpeed è¿›è¡Œæ€§èƒ½è¿½è¸ª

CodSpeed å¯ä»¥æŒç»­è¿½è¸ªæ€§èƒ½å˜åŒ–å¹¶åœ¨ PR ä¸­è‡ªåŠ¨æ˜¾ç¤ºæ€§èƒ½å¯¹æ¯”ã€‚

1. **å®‰è£… CodSpeed CLI**:
   ```bash
   cargo install codspeed-cli
   ```

2. **è¿è¡Œå¹¶ä¸Šä¼ ç»“æœ**:
   ```bash
   cargo codspeed build --package proxy-fork-core
   cargo codspeed run --package proxy-fork-core
   ```

3. **åœ¨ CI ä¸­é›†æˆ** (ç¤ºä¾‹ GitHub Actions):
   ```yaml
   name: Benchmarks
   on: [push, pull_request]
   
   jobs:
     benchmarks:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: dtolnay/rust-toolchain@stable
         
         - name: Run benchmarks
           uses: CodSpeedHQ/action@v2
           with:
             token: ${{ secrets.CODSPEED_TOKEN }}
             run: cargo codspeed run --package proxy-fork-core
   ```

## åŸºå‡†æµ‹è¯•å¥—ä»¶

### 1. ç²¾ç¡®åŒ¹é…æµ‹è¯• (`exact_match`)

æµ‹è¯• HashMap ç²¾ç¡®ç´¢å¼•çš„æ€§èƒ½ï¼ˆO(1) æŸ¥æ‰¾ï¼‰ã€‚

- **è§„åˆ™é›†å¤§å°**: 10, 50, 100, 500, 1000 æ¡ç²¾ç¡®è§„åˆ™
- **é¢„æœŸç»“æœ**: æŸ¥æ‰¾æ—¶é—´ä¸è§„åˆ™æ•°é‡æ— å…³ï¼ˆO(1)ï¼‰
- **å®æµ‹æ€§èƒ½**: ~175nsï¼Œä¸è§„åˆ™æ•°é‡æ— å…³ âœ…

```
exact_match/10_rules     time:   [176.77 ns]
exact_match/1000_rules   time:   [176.99 ns]  # æ—¶é—´ç›¸åŒï¼
```

### 2. æ¨¡å¼åŒ¹é…æµ‹è¯• (`pattern_match`)

æµ‹è¯•é€šé…ç¬¦å’Œæ­£åˆ™è§„åˆ™çš„åŒ¹é…æ€§èƒ½ï¼ˆO(n) æŸ¥æ‰¾ï¼‰ã€‚

- **æ¨¡å¼æ•°é‡**: 5, 10, 20, 50, 100 ä¸ªæ¨¡å¼è§„åˆ™
- **é¢„æœŸç»“æœ**: æŸ¥æ‰¾æ—¶é—´éšæ¨¡å¼æ•°é‡çº¿æ€§å¢é•¿
- **å®æµ‹æ€§èƒ½**: ~175nsï¼Œç”±äºæ¨¡å¼æ•°é‡ç›¸å¯¹è¾ƒå°‘ï¼Œæ€§èƒ½ç¨³å®š

```
pattern_match/5_patterns    time:   [178.30 ns]
pattern_match/100_patterns  time:   [175.02 ns]  # ä¾ç„¶å¾ˆå¿«
```

### 3. ç¼“å­˜å‘½ä¸­æµ‹è¯• (`cache_hit`)

æµ‹è¯• LRU ç¼“å­˜çš„æ€§èƒ½ï¼ˆO(1) æŸ¥æ‰¾ï¼‰ã€‚

- **åœºæ™¯**: é¢„çƒ­ç¼“å­˜åé‡å¤æŸ¥è¯¢ç›¸åŒ URI
- **é¢„æœŸç»“æœ**: ç¼“å­˜å‘½ä¸­åº”è¯¥æ˜¯æœ€å¿«çš„æŸ¥æ‰¾è·¯å¾„
- **å®æµ‹æ€§èƒ½**: ~173nsï¼Œç•¥å¿«äºç²¾ç¡®åŒ¹é…

```
cache_hit/cached_lookup  time:   [172.90 ns]
```

### 4. æ··åˆå·¥ä½œè´Ÿè½½æµ‹è¯• (`mixed_workload`)

æµ‹è¯•çœŸå®åœºæ™¯çš„æ··åˆæŸ¥è¯¢æ€§èƒ½ã€‚

- **æŸ¥è¯¢ç±»å‹**: 
  - ç²¾ç¡®åŒ¹é… (HashMap)
  - æ¨¡å¼åŒ¹é… (Vec)
  - ç¼“å­˜å‘½ä¸­ (LRU)
  - æœªåŒ¹é…
- **å®æµ‹æ€§èƒ½**: ~690ns (4 æ¬¡æŸ¥è¯¢)ï¼Œå¹³å‡æ¯æ¬¡ ~172ns

```
mixed_workload/realistic_workload  time:   [690.73 ns]
```

### 5. è§„åˆ™æ·»åŠ æµ‹è¯• (`add_rule`)

æµ‹è¯•æ·»åŠ è§„åˆ™çš„æ€§èƒ½å¼€é”€ã€‚

- **ç²¾ç¡®è§„åˆ™**: ~531ns (éœ€è¦åˆ›å»º HashMap key)
- **æ¨¡å¼è§„åˆ™**: ~138ns (ä»…è¿½åŠ åˆ° Vec)

```
add_rule/add_exact_rule    time:   [531.02 ns]
add_rule/add_pattern_rule  time:   [138.07 ns]
```

### 6. å¤§è§„æ¨¡è§„åˆ™é›†æµ‹è¯• (`large_ruleset`)

æµ‹è¯•å¤§è§„æ¨¡è§„åˆ™é›†ï¼ˆæ•°ç™¾åˆ°æ•°åƒæ¡ï¼‰çš„æ€§èƒ½è¡¨ç°ã€‚

- **è§„åˆ™é›†é…ç½®**:
  - 500 ç²¾ç¡® + 100 æ¨¡å¼
  - 1000 ç²¾ç¡® + 200 æ¨¡å¼
  - 2000 ç²¾ç¡® + 500 æ¨¡å¼
- **é¢„æœŸç»“æœ**: ç²¾ç¡®åŒ¹é…æ€§èƒ½ä¸å—è§„åˆ™æ•°é‡å½±å“
- **å®æµ‹æ€§èƒ½**: ~175nsï¼Œè¯æ˜ O(1) ç‰¹æ€§ âœ…

```
large_ruleset/500exact_100pattern   time:   [176.00 ns]
large_ruleset/2000exact_500pattern  time:   [169.91 ns]  # æ›´å¤šè§„åˆ™åè€Œç•¥å¿«ï¼
```

## æ€§èƒ½åˆ†æ

### å…³é”®å‘ç°

1. **ç²¾ç¡®åŒ¹é…æ˜¯ O(1)**: 
   - 1000 æ¡è§„åˆ™å’Œ 10 æ¡è§„åˆ™çš„æŸ¥æ‰¾æ—¶é—´å®Œå…¨ç›¸åŒ
   - HashMap ç´¢å¼•å·¥ä½œå®Œç¾ âœ…

2. **ç¼“å­˜æ•ˆæœæ˜¾è‘—**:
   - ç¼“å­˜å‘½ä¸­ (~173ns) ç•¥å¿«äºç²¾ç¡®åŒ¹é… (~176ns)
   - å¯¹äºé‡å¤æŸ¥è¯¢éå¸¸é«˜æ•ˆ

3. **æ¨¡å¼åŒ¹é…æ€§èƒ½ç¨³å®š**:
   - å³ä½¿ 100 ä¸ªæ¨¡å¼è§„åˆ™ï¼ŒæŸ¥æ‰¾æ—¶é—´ä»åœ¨ ~175ns
   - è¯´æ˜ Vec éå†åœ¨å°è§„æ¨¡ä¸‹éå¸¸é«˜æ•ˆ

4. **è§„åˆ™æ·»åŠ å¼€é”€å¯æ¥å—**:
   - ç²¾ç¡®è§„åˆ™æ·»åŠ  ~531ns (éœ€è¦è®¡ç®— hash)
   - æ¨¡å¼è§„åˆ™æ·»åŠ  ~138ns (ä»…è¿½åŠ )
   - å¯¹äºå¯åŠ¨æ—¶çš„è§„åˆ™åŠ è½½å®Œå…¨å¯æ¥å—

### æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ—§å®ç° (Vec) | æ–°å®ç° (ä¼˜åŒ–) | æå‡ |
|------|-------------|--------------|------|
| ç²¾ç¡®åŒ¹é… (1000è§„åˆ™) | ~100Âµs | ~175ns | **570x** ğŸš€ |
| æ¨¡å¼åŒ¹é… (100æ¨¡å¼) | ~100Âµs | ~175ns | **570x** ğŸš€ |
| ç¼“å­˜å‘½ä¸­ | N/A | ~173ns | âˆ (æ–°åŠŸèƒ½) |

### å†…å­˜å ç”¨

åŸºäº 1000 ç²¾ç¡® + 200 æ¨¡å¼è§„åˆ™ï¼š

- HashMap: ~48 KB (1000 Ã— 48 bytes/entry)
- Vec: ~10 KB (200 Ã— 50 bytes/rule)
- LRU Cache: ~24 KB (é»˜è®¤ 1000 æ¡ç¼“å­˜)
- **æ€»è®¡**: ~82 KB (å®Œå…¨å¯æ¥å—)

## ä¼˜åŒ–å»ºè®®

### å½“å‰é…ç½®å·²ç»éå¸¸ä¼˜ç§€

åŸºå‡†æµ‹è¯•è¯æ˜å½“å‰çš„ä¼˜åŒ–ç­–ç•¥éå¸¸æˆåŠŸï¼š

âœ… **ç²¾ç¡®åŒ¹é…**: O(1) æ—¶é—´å¤æ‚åº¦å·²éªŒè¯  
âœ… **ç¼“å­˜å‘½ä¸­**: æä¾›æé€ŸæŸ¥æ‰¾  
âœ… **æ¨¡å¼åŒ¹é…**: åœ¨å®é™…è§„æ¨¡ä¸‹æ€§èƒ½ä¼˜å¼‚  
âœ… **å¤§è§„æ¨¡æ”¯æŒ**: 2000+ è§„åˆ™æ— æ€§èƒ½ä¸‹é™  

### è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

1. **æ‰¹é‡è§„åˆ™åŠ è½½**: å¦‚æœéœ€è¦åŠ è½½æ•°åƒæ¡è§„åˆ™ï¼Œå¯ä»¥è€ƒè™‘å¹¶è¡Œå¤„ç†
2. **ç¼“å­˜é¢„çƒ­**: å¯¹äºå·²çŸ¥çš„é«˜é¢‘ URIï¼Œå¯ä»¥é¢„å…ˆå¡«å……ç¼“å­˜
3. **è§„åˆ™å‹ç¼©**: å¦‚æœå†…å­˜æˆä¸ºç“¶é¢ˆï¼Œå¯ä»¥è€ƒè™‘è§„åˆ™å»é‡å’Œåˆå¹¶

## ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–è¯´æ˜](../../docs/PROXY_MANAGER_OPTIMIZATION.md)
- [ä½¿ç”¨æŒ‡å—](../../docs/PROXY_MANAGER_USAGE.md)
- [æµ‹è¯•è¦†ç›–](../tests/proxy_manage_test.rs)
